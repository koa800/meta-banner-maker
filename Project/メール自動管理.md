# メール自動管理システム

## 基本情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | メール自動管理システム |
| 開始日 | 2026年2月18日 |
| 完了日 | 2026年2月18日 |
| ステータス | ✅ 完了（継続改善中） |

## 概要

個人Gmail（koa800sea.nifs@gmail.com）の受信メールを自動的に取得し、AIで「返信必要」「返信不要」を分類。学習型の削除フローで、初回は確認→承認後は自動削除。5回以上削除した送信者は自動ブロック（メールが届かなくなる）。毎日8時に自動実行し、Slackに通知。

### アーキテクチャ

```
┌─────────────┐                    ┌──────────────────┐
│   Gmail     │ ◀─── Gmail API ───│  mail_manager.py │
│   受信箱    │ ───────────────▶  │                  │
└─────────────┘                    │  - メール取得     │
                                   │  - AI分類        │
┌─────────────┐                    │  - 返信生成/送信  │
│   OpenAI    │ ◀── GPT-4o-mini ──│  - フィルター作成  │
│   API       │                    └──────────────────┘
└─────────────┘                            │
                                           │ Webhook
┌─────────────┐                            ▼
│   Slack     │ ◀──── 通知 ──────  #定常業務チャンネル
│   定常業務   │
└─────────────┘
```

## 実装した機能

### メール処理
1. **メール取得**: Gmail API で受信箱のメールを取得（ブロック済み送信者は除外）
2. **AI分類**: OpenAI GPT-4o-mini で返信必要/不要を自動判定
3. **返信文生成**: 返信が必要なメールには返信文を自動生成
4. **承認ワークフロー**: CLI で承認/編集/スキップ/削除を選択
5. **自動送信**: 承認後、同一スレッド内で返信を自動送信
6. **不要メール削除**: 不要判定のメールをゴミ箱に移動

### 学習型削除フロー
7. **削除確認**: 初めての送信者は「削除確認待ち」に入る
8. **学習**: 確認して承認すると、その送信者を「自動削除リスト」に追加
9. **自動削除**: 学習済み送信者は確認なしで自動削除
10. **自動ブロック**: 5回以上削除でGmailフィルターを作成（以後メールが届かない）

### 保護機能
11. **ラベル保護**: フォルダ/ラベル分けされているメールは削除しない
12. **イベント保護**: イベント予約、Lステップ通知などは削除しない

### 通知
13. **Slack通知**: 処理結果を #定常業務 チャンネルに通知
14. **通知内容**: 返信待ち件数、削除確認待ち件数、自動削除件数

### 保留機能
15. **保留記憶**: 保留にしたメールのIDを `state.json` の `held_message_ids` に記録
16. **再表示防止**: 保留済みメールは次回以降の分類処理でスキップされ、Web UIに再表示されない
17. **削除確認の保留**: 削除確認画面の「保留」ボタンも同じ動作（受信トレイに残しつつ非表示）

### フォルダ振り分け（Web UI）
18. **ラベル選択**: 既存のGmailラベル一覧から選択
19. **ラベル作成**: 新規ラベルをその場で作成可能
20. **フィルター作成**: 送信者→ラベルの自動振り分けフィルターを作成（今後の受信に自動適用）
21. **即時振り分け**: フィルター作成時、対象メッセージにもラベル付与＋受信トレイから即除去
22. **受信トレイスキップ**: メールを直接フォルダに入れる設定

## 技術スタック

| 項目 | 技術 |
|------|------|
| 言語 | Python 3.9 |
| メールAPI | Gmail API (OAuth 2.0) |
| AI | OpenAI GPT-4o-mini |
| 通知 | Slack Incoming Webhooks |
| スケジューラ | cron (毎時0分) |
| Web UI | Flask (localhost:5001) |

## 関連ファイル

| パス | 説明 |
|------|------|
| `System/mail_manager.py` | メインスクリプト |
| `System/receipt_downloader.py` | 領収書メールの添付・本文を取得して `Receipts/年/月` に保存 |
| `Receipts/` | 領収書保存フォルダ（年/月で整理）。README に rclone アップロード例あり |
| `System/mail_review_web/app.py` | Web UI（Flask） |
| `System/mail_inbox_data/state.json` | 送信者カウント・ブロック・学習・保留リスト |
| `System/mail_inbox_data/pending.json` | 返信待ちメール |
| `System/mail_inbox_data/delete_review.json` | 削除確認待ちメール |
| `System/mail_inbox_data/config.json` | Slack設定・OpenAI APIキー |
| `System/client_secret_personal.json` | 個人Gmail用OAuth認証情報 |
| `System/token_gmail_personal.json` | 個人Gmail用トークン |
| `System/mail_manager.log` | 実行ログ |

## 認証情報

| 項目 | 値 |
|------|------|
| Gmailアカウント | koa800sea.nifs@gmail.com（個人） |
| トークンファイル | `System/token_gmail_personal.json` |
| OAuth認証情報 | `System/client_secret_personal.json` |
| Slackアプリ名 | メール通知 |
| Slackチャンネル | #定常業務 |
| Webhook URL | config.json に保存済み |
| OpenAI APIキー | config.json に保存済み |

## 使い方

### 自動処理の流れ

```
毎時0分: 自動実行（cron）
    ↓
新着メールを取得・AI分類
    ↓
学習済み送信者は自動削除
    ↓
返信待ち・削除確認待ちがあればSlackに通知
    ↓
Web UI または Cursor で確認・処理
```

### Web UI（推奨）

```
http://localhost:5001/?account=personal
```

- 返信待ち・削除確認をブラウザで一覧表示
- 返信待ち: 「送信」「保留」「削除して学習」「📁 振り分け」ボタン
- 削除確認: 「削除して学習」「保留」「📁 振り分け」ボタン
- 保留したメールは受信トレイに残るが、今後Web UIには表示されない
- 「📁 振り分け」でフォルダ振り分け設定（既存ラベル選択 or 新規作成）
  - フィルター作成と同時に、現在のメールも即座に移動される

### 基本コマンド

```bash
# メール取得→分類→通知
python3 System/mail_manager.py run

# Web UI 起動
python3 System/mail_review_web/app.py

# 状態確認
python3 System/mail_manager.py status

# Slack通知テスト
python3 System/mail_manager.py slack-test

# 領収書メールから添付・本文をダウンロード（個人Gmail）
python3 System/receipt_downloader.py "Payment receipt" --from creem
```

### 自動実行（設定済み）

```
毎時0分に自動実行（cron）
- 個人: System/mail_inbox_personal.log
- 会社: System/mail_inbox_kohara.log
```

## AI分類の基準

| 判定 | 条件 |
|------|------|
| 返信必要（削除しない） | イベント予約、Lステップ通知、個人宛メッセージ、セキュリティ警告 |
| 返信不要（削除候補） | ニュースレター、広告、SNS通知、サービス更新通知 |
| 保護 | ラベル/フォルダ分けされているメールは削除しない |

## 学習フロー

| 回数 | 動作 |
|------|------|
| 1回目 | 削除確認 → 承認で学習 |
| 2〜4回目 | 自動削除（確認なし） |
| 5回目 | 自動削除 → ブロック（メールが届かなくなる） |

## state.json の構造

| キー | 型 | 説明 |
|------|------|------|
| `not_needed_count` | `{sender: count}` | 送信者ごとの不要判定回数 |
| `blocked_senders` | `string[]` | ブロック済み送信者 |
| `auto_delete_senders` | `string[]` | 自動削除対象の送信者 |
| `held_message_ids` | `string[]` | 保留済みメッセージID（今後非表示） |

## 注意事項

- Gmail OAuth トークンは定期的に更新が必要（期限切れ時は再認証）
- OpenAI API の利用料金に注意
- ブロックフィルターは「アーカイブ」なので、完全削除ではない
- Macがスリープ中はcronが実行されない
- `held_message_ids` はメッセージIDで管理しているため、同一送信者の別メールは保留にならない

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-18 | 初版作成。メール取得・分類・返信・ブロック・Slack通知 |
| 2026-02-18 | 個人Gmail対応、学習型削除フロー、ラベル保護、5回ブロック、毎日8時自動実行 |
| 2026-02-19 | Web UIにフォルダ振り分け機能を追加（ラベル選択・新規作成・フィルター設定） |
| 2026-02-21 | 保留機能強化（held_message_idsで再表示防止）、振り分け時の即時移動、削除確認「残す」→「保留」に統一 |
| 2026-02-24 | 領収書ダウンロード（receipt_downloader.py）、Receipts/ フォルダで整理 |
