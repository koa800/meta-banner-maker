# 環境全体マップ

## マシン構成

```
┌─ MacBook（開発・創造）─────────────────────────────┐
│                                                     │
│  ~/Desktop/cursor/          ← プロジェクト本体(Git)  │
│  ├─ CLAUDE.md               ← プロジェクト指示書     │
│  ├─ .cursor/rules/*.mdc     ← Cursorルール(24個)    │
│  ├─ System/                 ← コード本体            │
│  │  ├─ line_bot/            ← Render用(サブモジュール)│
│  │  ├─ line_bot_local/      ← エージェントソース     │
│  │  └─ mac_mini/            ← Orchestratorソース    │
│  ├─ Project/                ← ドキュメント           │
│  └─ Master/                 ← 知識ベース            │
│                                                     │
│  ~/Library/LineBot/          ← MacBook実行用コピー   │
│  │  (TCC制限で~/Desktopを読めないため)                │
│  │  post-commitフックで自動同期                       │
│  │                                                   │
│  ~/.claude/                  ← Claude Codeホーム     │
│  ├─ CLAUDE.md               ← グローバル指示書       │
│  ├─ settings.json           ← 権限設定              │
│  ├─ sync-cursor-rules.sh   ← .mdc→CLAUDE.md同期    │
│  └─ projects/.../memory/    ← 自動メモリ            │
│     ├─ MEMORY.md            ← メインメモリ          │
│     └─ video_ad_creative.md                         │
│                                                     │
│  ~/.ssh/id_ed25519          ← GitHub SSH鍵          │
│                                                     │
│  LaunchAgents:                                      │
│  ├─ com.linebot.localagent  ← local_agent常駐       │
│  ├─ com.claude.sync-cursor-rules ← ルール同期       │
│  ├─ com.addness.mac-mini-watchdog ← Mac Mini監視    │
│  └─ com.addness.csv-sheet-sync                      │
└──────────────────────────────────────────────────────┘
        │ git push (post-commit)     │ Tailscale
        ▼                            ▼
┌─ GitHub ──┐              ┌─ Mac Mini（自動化・常駐）──────────┐
│ main branch│  5分pull     │  mac-mini-agent (Tailscale)       │
│            │────────────>│  100.96.200.105                   │
└────────────┘             │                                    │
                           │  ~/agents/              ← 実行環境 │
                           │  ├─ line_bot_local/     ← エージェント│
                           │  ├─ System/mac_mini/    ← Orchestrator│
                           │  ├─ _repo/              ← git clone │
                           │  └─ token*.json         ← OAuth     │
                           │                                    │
                           │  Orchestrator (port 8500):          │
                           │  15タスク稼働（5分〜週次）            │
                           │                                    │
                           │  LaunchAgents:                      │
                           │  ├─ com.linebot.localagent          │
                           │  ├─ com.addness.agent-orchestrator  │
                           │  └─ git_pull_sync (5分)             │
                           └────────────────────────────────────┘
        │ HTTP (LINE通知)
        ▼
┌─ Render（Starter $7/月）──────────────────────────────┐
│  line-mention-bot-mmzu.onrender.com                   │
│  ├─ app.py          ← LINE Webhook受信               │
│  ├─ /notify         ← Mac Mini→LINE通知中継          │
│  ├─ /tasks          ← タスクキュー API                │
│  └─ /data           ← 永続ディスク（pending等）       │
│  Gitサブモジュール: git push → 自動デプロイ             │
└───────────────────────────────────────────────────────┘
```

## Claude Code の指示書（3層構造）

```
毎回の会話開始時に、上から順に全て読み込まれる:

① ~/.claude/CLAUDE.md              ← グローバル（全プロジェクト共通）
   内容: 言語設定 + Cursorルール自動同期
   編集者: sync-cursor-rules.sh（自動）+ 手書き

② ~/Desktop/cursor/CLAUDE.md       ← プロジェクト（このリポジトリ専用）
   内容: コミットルール、ドキュメント更新、技術選定フロー
   編集者: 人間 or Claude Code
   Git管理: あり

③ memory/MEMORY.md                 ← 自動メモリ（会話をまたいで記憶）
   内容: 学んだこと、ユーザー設定、技術メモ
   編集者: Claude Code
   Git管理: なし（ローカルのみ）
```

## CursorとClaude Codeの見え方

```
                      Cursor    Claude Code
グローバルCLAUDE.md     ✅         ✅ （sync経由で.mdcも含む）
プロジェクトCLAUDE.md   ✅         ✅
.cursor/rules/*.mdc    ✅         ❌ （sync経由でCLAUDE.mdに入る）
MEMORY.md              ❌         ✅
```

## Cursorルール同期の仕組み

```
.cursor/rules/*.mdc を編集・保存
        │
        ├─ WatchPaths検知 → 即時同期
        └─ 2時間タイマー → 定期同期（セーフティネット）
        │
        ▼
sync-cursor-rules.sh
        │
        ▼
~/.claude/CLAUDE.md
├─ 手書きゾーン（マーカーより上）← 編集しても安全
│  <!-- CURSOR_RULES_START -->
├─ 自動生成ゾーン              ← スクリプトだけが触る
│  （23ルール。addness-goals.mdcは277KBのため省略）
│  <!-- CURSOR_RULES_END -->

防御機構:
  ①マーカー分離  → Edit で壊れない
  ②重複検知     → Write丸ごと上書きでも自動復旧
  ③バックアップ  → ~/.claude/backups/ に5世代保持
  ④定期実行     → LaunchAgent 2時間ごと + Mac起動時
```

## データフロー

```
LINE メッセージ受信
  → Render (Webhook)
  → タスクキュー (/tasks)
  → Mac Mini local_agent (5秒ポーリング)
  → 処理（Claude API / coordinator / ツール実行）
  → Render /notify → LINE 通知

コード変更
  → git commit (MacBook)
  → post-commit hook → git push
  → Mac Mini git_pull_sync (5分) → rsync → サービス再起動

Cursorルール変更
  → .mdc 保存
  → LaunchAgent検知 → sync-cursor-rules.sh
  → ~/.claude/CLAUDE.md 更新

異常検知→回復（health_check 5分ごと）
  → local_agent停止 → 自動再起動(launchctl) → LINE報告
  → Q&Aモニター停止 → local_agent再起動 → LINE報告
  → メール通知失敗 → 5秒後リトライ
```

## 認証情報

```
GitHub: SSH鍵 (~/.ssh/id_ed25519)
Google: OAuth token*.json (System/credentials/ → Mac Mini ~/agents/)
  ├─ token.json (メイン)
  ├─ token_gmail.json (kohara)
  ├─ token_gmail_personal.json (個人)
  ├─ token_calendar_personal.json
  └─ token_gwsadmin.json
Anthropic: ANTHROPIC_API_KEY (環境変数 / plist)
LINE: LINE_CHANNEL_ACCESS_TOKEN (Render環境変数)
Render通知: AGENT_TOKEN (config.json)
```
