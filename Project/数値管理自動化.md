# 数値管理自動化プロジェクト

## 基本情報

| 項目 | 内容 |
|------|------|
| 目的 | アドネス事業KPIの日次データ収集・集計・可視化を自動化する |
| 対象データ | Looker Studio → CSV → Google Sheets（3シート連携） |
| スプレッドシート | [【アドネス全体】数値管理シート](https://docs.google.com/spreadsheets/d/1FOh_XGZWaEisfFEngiN848kSm2E6HotAZiMDTmO7BNA/edit) |
| スクリプト | `System/csv_sheet_sync.py` |
| LaunchAgent | `com.addness.csv-sheet-sync` |
| 最終更新 | 2026年2月23日（信頼性強化: スキーマ統一・アトミック書き込み・stale警告・異常値検知・目標KPI注入） |

---

## アーキテクチャ

```
Looker Studio（手動エクスポート）
    │
    ▼
~/Desktop/Looker Studio CSV/
  アドネス全体数値_媒体・ファネル別データ_表.csv  ← デフォルト名でOK
    │
    ▼  LaunchAgent（WatchPaths + 30分定期）
csv_sheet_sync.py
    │
    ├─⓪ 自動リネーム ─── 日付なしCSVに次の日付を自動付与
    │     例: → 2026-02-21_アドネス全体数値_媒体・ファネル別データ_表.csv
    │     ↓ (再スキャン)
    ├─① 元データシート ─── 対象日付 / ファイル名 / 投入日時 / ステータス
    │     ↓ (ステータス「完了」に変更)
    ├─② スキルプラス（日別） ─── 全CSV から再構築
    │     ↓
    ├─③ スキルプラス（月別） ─── 日別データから集計
    │     ↓
    └─④ KPIキャッシュ ─── kpi_summary.json（AI秘書が即座に参照）
```

---

## シート構成

### 元データ（gid: 1948910703）

管理台帳。CSVのダウンロード状況を追跡する。

| 列 | 内容 | 例 |
|---|---|---|
| A: 対象日付 | データの日付 | 2025-07-01 |
| B: CSVダウンロードタイプ | ファイル名 | 2025-07-01_アドネス全体数値_...csv |
| C: 投入日時 | 自動記入 | 2026-02-22 07:29 |
| D: ステータス | 要エクスポート → 完了 | 完了 |

### スキルプラス（日別）（gid: 285404084）

CSVの全行を日付付きで格納。ヘッダー4行 + データ行。

| 列 | フォーマット |
|---|---|
| A: 日付 | テキスト |
| B: 大カテゴリ | テキスト |
| C: 集客媒体 | テキスト |
| D: ファネル名 | テキスト |
| E: 集客数 | #,##0 |
| F: 個別予約数 | #,##0 |
| G: 実施数 | #,##0 |
| H: 売上 | ¥#,##0 |
| I: 広告費 | ¥#,##0 |
| J: CPA | ¥#,##0 |
| K: 個別CPO | ¥#,##0 |
| L: 単月ROAS | 0.0"%" |
| M: 単月LTV | ¥#,##0 |

### スキルプラス（月別）（gid: 1160127181）

日別データを「集客媒体 × ファネル名」の粒度で月別集計。各月の末尾に合計行あり。

| 列 | 計算方法 | フォーマット |
|---|---|---|
| A: 月 | YYYY-MM | テキスト |
| B: 集客媒体 | テキスト（合計行は "合計"） | テキスト |
| C: ファネル名 | テキスト（合計行は空） | テキスト |
| D: 集客数 | SUM | #,##0 |
| E: 個別予約数 | SUM | #,##0 |
| F: 実施数 | SUM | #,##0 |
| G: 売上 | SUM | ¥#,##0 |
| H: 広告費 | SUM | ¥#,##0 |
| I: CPA | 広告費 ÷ 集客数 | ¥#,##0 |
| J: CPO | 広告費 ÷ 個別予約数 | ¥#,##0 |
| K: ROAS | 売上 ÷ 広告費 × 100 | 0.0"%" |
| L: LTV | 売上 ÷ 集客数 | ¥#,##0 |
| M: 粗利 | 売上 − 広告費 | ¥#,##0 |

---

## 自動化フロー

### トリガー

| トリガー | タイミング |
|---|---|
| WatchPaths | `~/Desktop/Looker Studio CSV/` にファイル追加時（ThrottleInterval: 5秒） |
| StartInterval | 30分ごと定期実行（フォールバック） |

### 連鎖処理

1. **フォルダスキャン** — 日付付きCSVと日付不明CSVを分類
2. **日付不明CSV自動リネーム** — 既存CSVの最新日付の翌日を割り当て、ファイルをリネーム → LINE通知
3. **再スキャン** — リネーム後にフォルダを再スキャン（リネーム分も含む）
4. **元データに日付がなければ** → 行を自動追加（`要エクスポート`）
5. **CSVとマッチする行を更新** → ファイル名・投入日時・ステータス「完了」
6. **更新があれば** → スキルプラス（日別）を全CSVから再構築
7. **日別完了後** → スキルプラス（月別）を再集計
8. **月別完了後** → KPIキャッシュ（`kpi_summary.json`）を再生成
9. **各ステップ完了時** → LINE通知

> **更新がなければ③以降はスキップ**（API呼び出しの無駄なし）

---

## ファイル構成

| ファイル | 役割 |
|---|---|
| `System/csv_sheet_sync.py` | メインスクリプト（同期・構築・集計・キャッシュ生成） |
| `System/csv_sheet_sync.log` | 実行ログ |
| `System/csv_sheet_sync_notified.json` | 通知済みファイル記録（重複通知防止） |
| `System/kpi_summary.json` | KPIキャッシュ（AI秘書参照用、自動生成） |
| `System/sheets_manager.py` | Google Sheets API ラッパー（共通） |
| `System/sheets_sync.py` | 管理シート自動同期（Master/sheets/ CSVキャッシュ更新） |
| `System/token.json` | OAuth2 トークン（kohara アカウント） |

### LaunchAgent

| 項目 | 値 |
|---|---|
| plist | `~/Library/LaunchAgents/com.addness.csv-sheet-sync.plist` |
| 実行環境 | MacBook（Looker Studio CSVフォルダがあるため） |

---

## コマンドリファレンス

```bash
# デフォルト: 元データ同期 → 日別再構築 → 月別再集計（連鎖）
python3 System/csv_sheet_sync.py

# 確認のみ（書き込みしない）
python3 System/csv_sheet_sync.py --dry-run

# スキルプラス（日別）のみ再構築
python3 System/csv_sheet_sync.py build

# スキルプラス（月別）のみ再集計
python3 System/csv_sheet_sync.py monthly

# KPIキャッシュのみ再生成
python3 System/csv_sheet_sync.py cache
```

---

## CSVファイル命名規則

```
{YYYY-MM-DD}_{CSVタイプ名}.csv
```

例: `2026-02-20_アドネス全体数値_媒体・ファネル別データ_表.csv`

- **日付なし（デフォルト名）で保存してもOK** — 自動リネーム機能が次の日付を割り当てる
- 手動で日付を付けた場合はそのまま処理される

### 自動リネーム機能

Looker StudioからCSVをそのままエクスポートすると、日付なしのデフォルト名（`アドネス全体数値_媒体・ファネル別データ_表.csv`）で保存される。自動リネーム機能がこれを検出し、即座に処理する。

**ロジック**:
1. 既存の日付付きCSVから最新日付を取得
2. 翌日（= 次の未処理日付）を自動割り当て
3. `{next_date}_アドネス全体数値_媒体・ファネル別データ_表.csv` にリネーム
4. LINE通知で「📊 CSV自動リネーム: 2026-02-21 として処理します」と報告
5. リネーム後は通常の同期フローで処理

**複数ファイル対応**: 名前なしCSVが複数ある場合、ファイル更新日時順にソートし、連続する日付を割り当てる

---

## 環境変数・認証

| 変数/ファイル | 用途 |
|---|---|
| `System/token.json` | Google Sheets API（OAuth2 refresh_token） |
| `System/line_bot_local/config.json` → `agent_token` | LINE通知（Render経由） |
| Render `/notify` エンドポイント | LINE秘書グループへの通知転送 |

---

## AI秘書連携（KPIキャッシュ）

### 目的

AI秘書（LINE bot）がアドネス事業の数値について即座に回答できるようにする。

### ハイブリッド取得方式

| 優先度 | ソース | 条件 | 速度 |
|---|---|---|---|
| 1 | `kpi_summary.json`（freshキャッシュ） | 24時間以内に生成 | 即座（<1秒） |
| 2 | `kpi_cache_builder.py`（CSV再構築） | キャッシュなし or 期限切れ | 数秒 |
| 3 | Sheets API（リアルタイム） | CSV再構築失敗時 | 5〜10秒 |
| 4 | `kpi_summary.json`（staleキャッシュ） | API失敗時の最終手段（⚠️警告付き） | 即座（<1秒） |
| × | 使用不可 | 7日超のキャッシュ | エラー返却 |

> 精度 > 可用性（「分かりません」を最も避ける） > 速度

### 信頼性保証

| 対策 | 内容 |
|---|---|
| アトミック書き込み | tmpfile → rename で書き込み中の破損を防止（両キャッシュビルダー共通） |
| 空データ拒否 | 月別・日別データが両方空の場合、キャッシュ生成をスキップ |
| stale警告 | 24時間超のデータ使用時、Claudeプロンプトに「⚠️ X時間前のデータ」を注入 |
| 7日上限 | 7日超のキャッシュは完全拒否（古いデータで誤った回答をしない） |
| 異常値検知 | ROAS<0%、ROAS>1000%、負の売上、CPA>売上 等を自動検出してプロンプトに警告注入 |
| スキーマ統一 | `csv_sheet_sync.py` と `kpi_cache_builder.py` が同一JSON構造を出力 |
| 目標KPI注入 | Addnessゴールツリー（`Master/addness/goal-tree.md`）から甲原さんのKPI目標を動的抽出→Claude回答時に目標対比を表示 |

### キャッシュ構造（kpi_summary.json）

```json
{
  "updated_at": "2026-02-23T08:21:48",
  "monthly": [/* 月別全体KPI（集客数〜粗利）*/],
  "monthly_by_media": {/* 月別×集客媒体の内訳 */},
  "monthly_by_media_funnel": {/* 月別×集客媒体×ファネル別の内訳（全KPI指標付き）*/},
  "recent_daily": [/* 直近14日の日別合計 */],
  "recent_daily_by_media": {/* 直近14日×媒体の内訳 */},
  "report_summary": {/* 広告チーム日報サマリー（当月目標vs実績）*/},
  "source": "csv_cache"
}
```

> `csv_sheet_sync.py` と `kpi_cache_builder.py` の両方が同一構造を出力する。フォールバック時のデータ欠損なし。

### AI秘書への注入タイミング

`local_agent.py` の `fetch_addness_kpi()` がアドネス関連の会話を検知した際に、キャッシュを読み込んでClaudeのシステムプロンプトに注入する。

### KPIデータ開示ルール

**事業KPIは機密情報として扱い、開示対象を制限する。**

| 開示 | カテゴリ | 例 |
|---|---|---|
| **許可** | 本人、上司、直下メンバー、横（並列） | アドネススタッフ全般 |
| **禁止** | 外部パートナー、プロファイル未登録者 | 業務委託先、未知の送信者 |

- `local_agent.py` でカテゴリをホワイトリスト判定（`_KPI_ALLOWED_CATEGORIES`）
- 禁止対象からKPI関連の質問が来た場合、データ注入をスキップ（ログに記録）
- プロファイル未登録者も安全側に倒して非開示
- **例外**: プロファイルの `related_sheets` に登録されたシートデータは外部パートナーにも開示される（個別に共有しているデータは会話に使ってよい）

### 想定される質問例

- 「今月のROASは？」→ monthly の最新月を参照
- 「最近のMeta広告の傾向は？」→ monthly_by_media の直近3ヶ月を比較
- 「ざっくり今月どれぐらい？」→ monthly の最新月サマリ
- 「YouTube広告の数値どんな感じ？」→ monthly_by_media でYouTube抽出
- 「AIファネルのCPAは？」→ monthly_by_media_funnel で該当ファネル抽出
- 「Meta広告のセンサーズファネルの推移は？」→ monthly_by_media_funnel で媒体×ファネル指定

---

## 管理シート自動同期（sheets_sync）

### 概要

`Master/sheets/README.md` に登録された外部管理シート（Google Sheets）のデータを毎日自動でCSVキャッシュとして同期する仕組み。AIが最新の事業数値を参照できるようにする。

### アーキテクチャ

```
Master/sheets/README.md（登録シート一覧）
    │
    ▼  Orchestrator cron 毎朝 6:30
sheets_sync.py
    │
    ├─ gspread で各シートのメタデータ・全タブデータを取得
    ├─ タブごとに CSV として Master/sheets/{シートID}/ に保存
    ├─ _meta.json にメタ情報を保存
    └─ README.md の「同期」列をタイムスタンプ+行数で更新
```

### 同期対象シート

| ID | シート名 | 用途 |
|---|---|---|
| `1FOh_XGZWaEi...` | 【アドネス全体】数値管理シート | 事業KPI・会社全体の重要数値 |
| `16W1zALKZrnG...` | 【広告チーム】報告シート | チーム日報・週報・月報・年報 |

### ファイル構成

| ファイル | 役割 |
|---|---|
| `System/sheets_sync.py` | 管理シート同期スクリプト |
| `Master/sheets/README.md` | 登録シート一覧・同期ステータス |
| `Master/sheets/{シートID}/` | タブごとのCSVキャッシュ |
| `Master/sheets/{シートID}/_meta.json` | シートメタ情報（タイトル・タブ一覧・同期日時） |

### コマンドリファレンス

```bash
# 全シート同期
python3 System/sheets_sync.py

# 確認のみ（書き込みしない）
python3 System/sheets_sync.py --dry-run

# 特定シートのみ同期
python3 System/sheets_sync.py --id SHEET_ID
```

### 新規シート追加方法

`Master/sheets/README.md` のテーブルに1行追加するだけで、次回の同期対象になる。

---

## 注意事項

- **CSVの日付はファイル名で管理** — CSV内容からの自動判定は行わない（誤判定リスク）
- **月別KPIは合算から再計算** — 日別のCPA/ROASを合計するのではなく、集計値から算出
- **全データ再構築方式** — 差分更新ではなく毎回全CSVから再構築するため、過去データの修正にも対応
- **2026-02は途中月** — 月末まで集計するとROAS等の数値が変動する
- **kpi_summary.jsonは自動生成** — 手動編集不要。git管理外でも可（各環境で自動生成される）
