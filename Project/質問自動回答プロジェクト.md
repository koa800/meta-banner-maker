# 質問自動回答プロジェクト

## 概要

スキルプラス受講生からの質問に対して、AIが回答案を自動生成し、講師の承認後にスプレッドシートへ書き込むシステム。

---

## システム構成

```
┌─────────────────────────────────────────────────────────────────┐
│  受講生                                                          │
│  ├─ L-step回答フォーム → スプレッドシート（回答用シート）           │
│  └─ Success Learning AI → スプレッドシート（回答用SLS）            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  PCローカルエージェント（local_agent.py）                         │
│  ├─ 60秒ごとにスプレッドシートをポーリング                         │
│  ├─ 新規質問を検出 → サーバーへ送信                               │
│  └─ 承認済み回答を取得 → スプレッドシートへ書き込み                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Renderサーバー（line_bot/app.py）                               │
│  ├─ 質問受信 → AI回答生成 → LINE通知                             │
│  ├─ 講師からの承認コマンド処理                                    │
│  └─ 承認済み回答を保持（ローカルエージェントが取得）                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  講師（LINE AI秘書グループ）                                      │
│  ├─ 質問＋AI回答案の通知を受信                                    │
│  ├─ 承認コマンドで回答を確定                                      │
│  └─ スプレッドシートから手動で受講生へ返信                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 処理フロー

### 1. 質問検出〜AI回答生成

```
1. 受講生がL-stepまたはSLSで質問を送信
2. 質問がスプレッドシートの「回答用」シートに追加される
3. ローカルエージェントが60秒ごとにシートをチェック
4. 未処理の質問を検出（sent_idsで管理）
5. 質問データをRenderサーバーへ送信
   - シート名、行番号、質問内容、目的、やったこと、ユーザーID
```

### 2. AI回答生成〜LINE通知

```
1. サーバーが質問を受信
2. Pinecone（ベクトルDB）で類似の過去質問を検索
3. Skillsディレクトリからノウハウを読み込み
   - 過去の質問回答.md（Google Docsから同期）
   - ワークフローの考え方.md
   - 動画広告クリエイティブ制作フロー.md
   - action-map-feedback-prompt.md
4. OpenAI GPT-4o-miniでAI回答を生成
5. LINE AI秘書グループへ通知
   - 質問内容、目的、やったこと、AI回答案、承認コマンド
```

### 3. 承認〜スプレッドシート書き込み〜ナレッジ蓄積

```
1. 講師がLINEで承認コマンドを送信
   - 「1」: そのまま承認
   - 「2 修正内容」: 修正して承認
   - 「3」: 動画回答（手動対応）
2. リプライで特定の質問を指定可能（リプライなしは最新）
3. サーバーが回答を「approved」状態で保存
4. 承認済みQ&AをPinecone（ベクトルDB）に自動upsert → ナレッジとして蓄積
   - 質問テキストをOpenAI Embeddingでベクトル化
   - メタデータ: 質問・回答・承認者・承認日時・ソース
   - 次回以降の類似質問検索時に自動で参照される
5. ローカルエージェントが承認済み回答を取得
6. スプレッドシートの「回答」列に書き込み
   - 「回答済み」チェックは講師が手動で行う
```

---

## スプレッドシート構成

### 対象シート

| シート名 | ソース | 回答列 | 状態列 |
|---------|--------|--------|--------|
| 回答用：サポートLINE | L-step | Q列 | O列 |
| 回答用：スタンダード | L-step | Q列 | O列 |
| 回答用：エリート | L-step | Q列 | O列 |
| 回答用：プライム | L-step | Q列 | O列 |
| 回答用：SLS | Success Learning AI | L列 | J列 |

### 列構成（L-stepシート）

| 列 | 内容 |
|----|------|
| A | タイムスタンプ |
| B | 名前 |
| C | LINE名 |
| F | 目的（Goal） |
| G | やったこと（Action） |
| H | 質問内容 |
| N | L-STEPリンク（member=xxxからユーザーID取得） |
| O | 回答済み（TRUE/FALSE）※講師が手動チェック |
| Q | 回答（AIが書き込み） |

### 列構成（SLSシート）

| 列 | 内容 |
|----|------|
| A | タイムスタンプ |
| B | 名前 |
| H | 質問内容 |
| J | 回答済み（TRUE/FALSE）※講師が手動チェック |
| L | 回答（AIが書き込み） |

---

## ファイル構成

```
System/
├── line_bot/                    # Renderサーバー
│   ├── app.py                   # メインアプリ
│   ├── qa_handler.py            # Q&A処理ロジック
│   ├── skills/                  # AIナレッジ
│   │   ├── 過去の質問回答.md
│   │   ├── ワークフローの考え方.md
│   │   ├── 動画広告クリエイティブ制作フロー.md
│   │   └── action-map-feedback-prompt.md
│   └── requirements.txt
│
├── line_bot_local/              # PCローカルエージェント
│   ├── local_agent.py           # メインエージェント
│   ├── qa_monitor.py            # スプレッドシート監視
│   ├── sync_knowledge.py        # ナレッジ同期
│   ├── config.json              # サーバーURL等の設定
│   └── qa_monitor_state.json    # 処理済みID管理
│
└── token.json                   # Google API認証トークン
```

---

## 環境変数（Render）

| 変数名 | 用途 |
|--------|------|
| LINE_CHANNEL_SECRET | LINE Messaging API |
| LINE_CHANNEL_ACCESS_TOKEN | LINE Messaging API |
| OPENAI_API_KEY | OpenAI API |
| PINECONE_API_KEY | Pinecone（任意） |
| LOCAL_AGENT_TOKEN | ローカルエージェント認証 |
| SECRETARY_GROUP_ID | 通知先LINEグループID |

---

## 承認コマンド

| コマンド | 動作 |
|----------|------|
| `1` | AI回答をそのまま承認→スプレッドシートに書き込み |
| `2 修正内容` | 修正内容で承認→スプレッドシートに書き込み |
| `3` | 動画回答フラグ→講師が手動で対応 |

**リプライ機能**: 通知メッセージにリプライしてコマンドを送ると、その質問を対象に処理。リプライなしは最新の未処理質問を対象。

---

## ナレッジ同期

Google Docs「発生した悩み一覧（マーケ）」の内容を定期的にSkillsへ同期。

```bash
# 手動同期
python3 System/line_bot_local/sync_knowledge.py
```

---

## 起動方法

### ローカルエージェント起動

```bash
cd System/line_bot_local
python3 local_agent.py
```

### サーバー（Render）

GitHubへpush後、自動デプロイ。

---

## ナレッジ蓄積ループ

```
承認
  → Pinecone upsert（質問をベクトル化 + 回答メタデータ）
     → 次回の類似質問検索で自動参照
        → AI回答の精度が向上
           → 承認 → さらにPinecone蓄積...
```

**自動学習サイクル**: 承認するたびにナレッジが蓄積され、類似の質問に対してより的確な回答案が生成されるようになる。Pinecone未設定の環境ではスキップされ、スプレッドシート書き込みのみ実行される。

---

## 注意事項

1. **回答済みチェックは手動**: AIはスプレッドシートの「回答」列のみ書き込み。「回答済み」チェックは講師が確認後に手動で行う。

2. **アカウント分離**: 個人アカウント（koa800sea.nifs@gmail.com）と会社アカウント（kohara.kaito@team.addness.co.jp）のリソースは混在させない。

3. **sent_idsによる重複防止**: 一度処理した質問はIDで管理され、再処理されない。

4. **Q&Aデータ永続化**: `QA_PENDING_FILE` は `DATA_DIR`（Render永続ディスク `/data`）に保存。デプロイ後も保留中の質問が消えない。

5. **Pineconeナレッジ蓄積**: 承認時に自動でベクトルDBに蓄積。`PINECONE_API_KEY` 環境変数が未設定の場合はスキップ（エラーにはならない）。
