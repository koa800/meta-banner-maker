# 定常業務マニュアル

最終更新: 2026-03-01（通知をLINEに統一、日報リマインド追加）

---

## 秘書のChrome MCPテスト（初回・再設定後）

日報自動入力は Mac Mini 上で秘書（Claude Code CLI + Chrome MCP）がブラウザで Looker Studio を開いて実行する。以下を満たしたうえで1回動作確認する。

### 前提条件（Mac Mini）

| 項目 | 確認方法 |
|------|----------|
| `~/.claude-secretary/` が存在 | `ls -la ~/.claude-secretary` |
| Chrome が起動可能 | 手動で「Google Chrome」を起動できること |
| Claude Code CLI に `--chrome` 対応 | Orchestrator が日報・Looker CSV 実行時に `--chrome` を付与（scheduler.py で use_chrome=True） |

### テストのやり方

1. **自動実行で確認**: 翌朝 08:40 の `daily_report_input` で成功すればOK。失敗時は LINE に通知が届く。
2. **手動で試す**: Mac Mini で秘書（LINE local agent）が動いている場合、LINE で「日報入れて」と送ると Claude Code + Chrome MCP で日報入力が実行される。成功すれば Chrome MCP テスト完了。

### よくある失敗と対処

- **Chrome MCP に接続できません** → Chrome を起動し、Claude in Chrome 拡張が有効か確認。必要なら Chrome を再起動。
- **Looker Studio の Google ログインが切れています** → Mac Mini の Chrome で Looker Studio に再ログイン（対象アカウントで）。

---

## 日報入力

### 自動実行（毎朝8:40）

Orchestrator `daily_report_input` タスクが毎朝8:40に自動実行。秘書がClaude Code経由でLooker Studioからデータ取得→日報シート書き込み→LINE報告まで一気通貫で行う。手動操作不要。

- **実行時刻**: 毎朝 08:40（config.yaml `daily_report_input`）
- **事前チェック**: 08:25 に `oauth_health_check` が Google + Claude Code OAuth トークンを検査・自動リフレッシュ
- **実行者**: 秘書（Claude Code CLI + Chrome MCP）
- **対象日**: 前日分
- **タイムアウト**: 15分（ブラウザ操作 + Sheets API で多くのターン数が必要なため）
- **最大ターン数**: 40（ブラウザ操作があるため多めに設定）
- **リトライ**: 失敗時 60秒後に自動リトライ（最大2回）
- **失敗時**: LINE に通知（エラー種別ごとに具体的な復旧手順を案内）
- **完了検証**: 09:20 に `daily_report_verify` がシートの実データを自動確認。未入力があれば LINE で通知
- **日報リマインド**: 平日 12:00/19:00 に `daily_report_reminder` がチームメンバーの未記入を検出 → 赤ハイライト + LINE 通知

### プリフライトチェック（自動実行前に確認される項目）

| チェック項目 | 失敗時の動作 |
|---|---|
| Claude Code CLI 存在 | LINE で通知、タスク中止 |
| `~/.claude-secretary` 存在 | LINE で通知、タスク中止 |
| Claude Code OAuthトークン | 期限切れ or 1時間以内 → CLI起動で自動リフレッシュ。リフレッシュ失敗なら通知 |
| Chrome 起動中か | 未起動なら自動起動（10秒待機）。起動失敗なら通知 |

### 手動実行

ユーザーが「日報報告して」「日報入れて」等と言ったら以下を実行する。

### データ取得元

| データ | 取得元 | 方法 |
|---|---|---|
| 集客数・個別予約数・着金売上 | Looker Studio（日別データ） | ブラウザで開いてスクショ読み取り |
| スキルプラス会員数・解約数 | Looker Studio（会員数ページ） | ブラウザで開いてスクショ読み取り |
| サブスク新規会員数 | Google Sheet（数値管理マスターデータ） | API で日付カウント |

### Looker Studio URL（直リンク）

ページ遷移せず直接開くこと。メニューを辿る必要はない。

| ページ | URL |
|---|---|
| 日別データ（集客数・個別予約数・着金売上） | `https://lookerstudio.google.com/u/1/reporting/f3d08756-9297-4d34-b6ea-ea22780eb4d2/page/p_evmsc9twzd` |
| スキルプラス会員数（会員数・解約数） | `https://lookerstudio.google.com/u/1/reporting/f3d08756-9297-4d34-b6ea-ea22780eb4d2/page/p_dfv0688m0d` |

### サブスク新規会員数の取得方法

b→dash のグラフは精度が低いため使わない。以下の Google Sheet から取得する。

- **シートID**: `1gOVSt0PDub3-W8fBglKnuUAIub3FOyv-1X8CdFEvm70`
- **タイトル**: 【月額スキルプラス】数値管理マスターデータ
- **参照タブ**: `秘密の部屋（月額）` と `秘密の部屋（年額）` のみ
- **カウント方法**: 各タブの A列（日時）に対象日付（`YYYY-MM-DD`）を含む行数を合算

```bash
cd /Users/koa800/Desktop/cursor
for sheet in "秘密の部屋（月額）" "秘密の部屋（年額）"; do
  count=$(python3 System/sheets_manager.py read "1gOVSt0PDub3-W8fBglKnuUAIub3FOyv-1X8CdFEvm70" "$sheet" "A1:A5000" 2>&1 | grep "対象日付" | wc -l)
  echo "$sheet: $count"
done
```

### 日報データ取得手順

1. **Looker Studio 日別データページを直接開く**
   - ページ遷移やメニュー操作は不要（直リンクで該当ページに着く）
   - **【必須】ページ読み込み後、ブラウザを幅1400px・高さ900pxにリサイズしてからスクショを撮る**
     ```
     browser_resize(width=1400, height=900)
     ```
   - **【必須】スクショ後、テーブル上部をズームイン撮影して先頭行（前日分）の数字を再確認する**
     - 全体スクショで読んだ数値をそのまま使わない。必ずズーム確認を行う
   - 前日分の集客数・個別予約数・着金売上を読み取る

2. **Looker Studio 会員数ページを直接開く**
   - **【必須】ブラウザを幅1400px・高さ900pxにリサイズしてからスクショを撮る**
   - スクショからスキルプラス会員数（net change）・解約数を読み取る

3. **サブスク新規会員数を API で取得**
   - 上記の `sheets_manager.py read` + `grep` コマンドでカウント
   - ブラウザ操作不要

4. **日報シートへの入力前に、取得した全数値を一覧でユーザーに提示して確認を取る**
   - 確認後に書き込む（「確認不要」と言われた場合のみスキップ）

### 出力先シート

- スプレッドシート: 【広告チーム】報告シート
- ID: `16W1zALKZrnGeesjTlmsraDfw3i71tcdYJE686cmUaTk`
- シート名: `日報` (gid: 1717970415)

### 入力手順

1. 日報シートの1行目ヘッダーを読み、対象日付の列を特定する:
   ```bash
   python3 System/sheets_manager.py read "16W1zALKZrnGeesjTlmsraDfw3i71tcdYJE686cmUaTk" "日報" "A1:JZ1"
   ```
   ヘッダーは `M/D` 形式（例: `2/20`）。列番号を数える（F=2/1, G=2/2, ...）
2. 以下の行に書き込む（列はヘッダーから特定した列）:
   - 行5: 着金売上（確定ベース）← Looker Studio 日別データ
   - 行7: 集客数 ← Looker Studio 日別データ
   - 行9: 個別予約数 ← Looker Studio 日別データ
   - 行13: スキルプラス会員数 ← Looker Studio 会員数ページ
   - 行14: 解約数 ← Looker Studio 会員数ページ
   - 行15: サブスク新規会員数 ← Google Sheet API
3. **スキップする項目:**
   - 行4: 粗利益（計算式あり、触らない）
   - 行6: 広告費（別管理のためスキップ）
4. 書き込みコマンド:
   ```bash
   python3 System/sheets_manager.py write "16W1zALKZrnGeesjTlmsraDfw3i71tcdYJE686cmUaTk" "{列}{行}" "{値}" "日報"
   ```
5. 書き込み後、結果をテーブルで表示する

---

## Looker Studio CSVダウンロード

### 自動実行（毎日11:30）

Orchestrator `looker_csv_download` タスクが毎日11:30に自動実行。秘書がClaude Code経由でLooker Studioを開き、前々日分のCSVをダウンロード。12:00の `kpi_daily_import` がこのCSVを自動処理する。

- **実行時刻**: 毎日 11:30（config.yaml `looker_csv_download`）
- **対象日**: 前々日（2日前）
- **タイムアウト**: 8分

### 手動実行

「日報入れて」と言われたらCSVダウンロード＋日報入力をセットで実行する。

### 対象ページ

- **URL**: `https://lookerstudio.google.com/u/1/reporting/f3d08756-9297-4d34-b6ea-ea22780eb4d2/page/p_dsqvinv6zd`
- **ページ名**: 媒体・ファネル別データ（このページのみ）

### 保存先・ファイル名

- **保存先**: `~/Desktop/Looker Studio CSV/`
- **ファイル名**: `{YYYY-MM-DD}_アドネス全体数値_媒体・ファネル別データ_表.csv`
- **デフォルト日付**: 指定なしなら2日前（前々日）

### 操作手順

1. URL を開く
2. 日付フィルターを変更（詳細設定 → 開始日/終了日を同日に設定）
3. テーブルを右クリック → グラフをエクスポート → データのエクスポート → CSV → エクスポート
4. ダウンロードされたファイルを保存先に移動 & リネーム

### 後続パイプライン

Mac Mini Orchestrator `kpi_daily_import`（毎日12:00）が自動でCSV → スプレッドシート取り込み。

---

## 完了報告（LINE）

**定常業務（🔄 ステータス）を実行・完了したら、必ずLINEで完了報告を送信する。これは省略不可。**

### 対象タスク

Addnessの甲原海人の定常業務（🔄）。代表例:

- 報告シート記入/確認する
- 全体数値報告
- スキルプラス広告コースに来ている質問回答
- メール確認/返信
- 日報入力

上記に限らず、定常業務を完了した際は全て報告対象。

### 報告の実行方法

```bash
# 完了時刻を含める場合は事前に変数に代入する
current_time=$(date +%H:%M)
python3 System/line_notify.py "メッセージ...完了時刻: ${current_time}"
```

**注意**: heredocを使う場合は `<<EOF`（クォートなし）を使うこと。`<<'EOF'` だと `$(date)` 等のコマンド置換が展開されずそのまま文字列として送信される。

### 報告内容のフォーマット

```
✅ 定常業務完了: {タスク名}
━━━━━━━━━━━━
{主要な数値（あれば）}
{異常値フラグ（あれば）}
━━━━━━━━━━━━
完了時刻: {HH:MM}
```

#### 数値がある場合の例

```
✅ 定常業務完了: 日報入力
━━━━━━━━━━━━
集客数: 1,234人
個別予約数: 89件
着金売上: ¥12,345,678
会員数: 5,432人（解約: 12人）
サブスク新規: 8人
━━━━━━━━━━━━
⚠️ 集客数が前日比 -30% で要確認
━━━━━━━━━━━━
完了時刻: 14:30
```

#### 数値がない場合の例

```
✅ 定常業務完了: メール確認/返信
━━━━━━━━━━━━
対応件数: 5件（うち要フォロー: 1件）
━━━━━━━━━━━━
完了時刻: 09:15
```

### 異常値の検知基準

以下に該当する場合、報告に `⚠️` フラグを付ける:

- 集客数が前日比 ±20% 以上の変動
- 解約数が通常の2倍以上
- 着金売上が前日比 -30% 以上
- その他、明らかに通常と異なる数値

### 報告のタイミング

- タスク完了の直後に送信する
- 複数の定常業務を連続で実行した場合は、まとめて1通で報告してよい
